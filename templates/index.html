<!doctype html>
<html>
<head>
	<style type='text/css'>
		body {
			margin: 0px;
			padding: 0px;
			font: 1.6em 'Georgia', 'Tahoma', serif;
			color: #333;
			height: 100%;
			background-color: #fbfbfb;
			font: 22px 'Monaco', 'Menlo', 'Ubuntu Mono', 'Droid Sans Mono', 'Consolas', monospace;
		}

		#header-content {
			width: 100%;
			min-width: 640px;
			margin: 0 auto;
		}
		input, textarea, button {
			font: 15px 'Monaco', 'Bitstream Vera Sans', 'Courier', monospace;
		}
		body {
			overflow: auto;
		}

		#ace-editor {
			height:100%;
			width: 99%;
		}

		#markdown-display{
			display:none;
			border:2px inset #cdcdcd;
			font-size: .60em;
			padding: 5px;
			background-color: #ffffff
		}

		#markdown-edit{
			display:none;
			cursor: pointer;
			font-size: .65em;
		}
		#short_url{
			width:275px;
		}
		#content{
			height:100%;
		}
	</style>
	<!-- <link rel="stylesheet" href="/static/js/highlight/styles/default.css"> -->
	<link rel="stylesheet" href="/static/js/highlight/styles/github.css">
</head>
<body>
	<div id="content">
		<div id="header-content">
			<h1>Pastie</h1>
			<label for='short_url'>URL:</label>
			<input type='text' disabled='disabled' id='short_url'></input>
			<span style="float: right">
				<label for='language'>Language:</label>
				<select id='language'>
					<option value='text'>Plaintext</option>
					<option value='sh'>Bash</option>
					<option value='csharp'>C#</option>
					<option value='javascript'>Javascript</option>
					<option value='json'>JSON</option>
					<option value='lua'>Lua</option>
					<option value='markdown'>Markdown</option>
					<option value='perl'>Perl</option>
					<option value='python'>Python</option>
					<option value='sql'>SQL</option>
					<option value='xml'>XML</option>
				</select>
				<button id="save-button">Save</button>
			</span>
		</div>

		<table id="editor-container">
			<tr>
				<td style="width:50%;display:inline-block;">
					<div id="ace-editor"></div>
				</td>
				<td style="width:50%">
					<div id="markdown-display"></div>
					<button type="button" id="markdown-edit">Show Markdown</button>
				</td>
			</tr>
		</table>

	</div>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/ace-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-xml-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-javascript-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-perl-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-csharp-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-json-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-text-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-markdown-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-python-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-sql-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-xml-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-sh-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/ace/build/src/mode-lua-noconflict.js" type="text/javascript"></script>
	<script src="/static/js/showdown.js" type="text/javascript"></script>
	<script src="/static/js/highlight/highlight.pack.js" type="text/javascript"></script>
	<script type="text/javascript">

		function initEditor() {
			window.aceEditor = ace.edit("ace-editor");
			window.aceEditor.setTheme("ace/theme/monokai");
			window.aceEditor.renderer.setShowPrintMargin(false);
			window.aceEditor.setHighlightActiveLine(false);
		}

		converter = new Showdown.converter();

		//Get ace editor text and convert it to markup with showdown
		var convertText = function() {
			//$('#ace-editor').slideUp();
			// get input text
			var text = window.aceEditor.getSession().getValue();
			// Do the conversion
			text = converter.makeHtml(text);

			$('#markdown-display').html(text);
			$('pre code').each(function(i, e) {hljs.highlightBlock(e)});
			window.aceEditor.resize();

		};

		//Toggle ace editor language modes
		function setAceMode( language ){
			var XMLMode = ace.require("ace/mode/xml").Mode
				, JSMode = ace.require("ace/mode/javascript").Mode
				, PerlMode = ace.require("ace/mode/perl").Mode
				, CsharpMode = ace.require("ace/mode/csharp").Mode
				, JSONMode = ace.require("ace/mode/json").Mode
				, LuaMode = ace.require("ace/mode/lua").Mode
				, TextMode = ace.require("ace/mode/text").Mode
				, PythonMode = ace.require("ace/mode/python").Mode
				, MarkdownMode = ace.require("ace/mode/markdown").Mode
				, ShellMode = ace.require("ace/mode/sh").Mode
				, SQLMode = ace.require("ace/mode/sql").Mode
				, XMLMode = ace.require("ace/mode/xml").Mode

			$('#ace-editor').width( $('#ace-editor').parent().width() * .99 );
			$('#ace-editor').height( $(window).height() - $('#header-content').height() - 50 );
			columnMode('normal');
			//window.aceEditor.resize();

			//$('#markdown-display').hide();

			if ( language === 'text'){
				window.aceEditor.getSession().setMode(new TextMode());
			}else if( language === 'javascript'){
				window.aceEditor.getSession().setMode(new JSMode());
			}else if( language === 'json'){
				window.aceEditor.getSession().setMode(new JSONMode());
			}else if( language === 'csharp'){
				window.aceEditor.getSession().setMode(new CsharpMode());
			}else if( language === 'perl'){
				window.aceEditor.getSession().setMode(new PerlMode());
			}else if( language === 'python'){
				window.aceEditor.getSession().setMode(new PythonMode());
			}else if( language === 'lua'){
				window.aceEditor.getSession().setMode(new LuaMode());
			}else if( language === 'markdown'){
				window.aceEditor.getSession().setMode(new MarkdownMode());
				var $markdownDisplay = $('#markdown-display')
					, $aceEditor = $('#ace-editor');
					columnMode('markdown');
				convertText();
				fitEditor();
			}else if( language === 'sql'){
				window.aceEditor.getSession().setMode(new SQLMode());
			}else if( language === 'sh'){
				window.aceEditor.getSession().setMode(new ShellMode());
			}else if( language === 'xml'){
				window.aceEditor.getSession().setMode(new XMLMode());
			}
		}

		//Resize the ace editor to fit into its parent container and the window height
		var fitEditor = function(){
			$('#ace-editor').width( $('#ace-editor').parent().width() * .99 )
			$('#ace-editor').height( $(window).height() - $('#header-content').height() - 50 );
			window.aceEditor.resize();
		}

		var columnMode = function(mode){
			var $markdownDisplay
				, $markdownEdit
				, $aceEditor;

			$markdownDisplay = $('#markdown-display');
			$aceEditor = $('#ace-editor');
			$markdownEdit = $('#markdown-edit');

			if (mode === 'markdown'){
				$markdownDisplay.parent().width('100%');
				$aceEditor.parent().width('100%');
				$aceEditor.parent().css('display','inline-block');
				$markdownDisplay.show();
				$markdownEdit.show()
				$aceEditor.hide();
			}else if (mode === 'markdown-edit'){
				$markdownDisplay.parent().width('50%');
				$aceEditor.parent().css('display','inline-block');
				$aceEditor.parent().width('100%');
				$markdownDisplay.show();
				$aceEditor.show();
			}else if (mode === 'normal'){
				$markdownDisplay.parent().width('0%');
				$aceEditor.parent().width('100%');
				$aceEditor.parent().css('display','table-cell');
				$aceEditor.show();
				$markdownDisplay.hide();
				$markdownEdit.hide()
			}

			fitEditor();
		}

		$(function(){
			//Initialize ace editor
			initEditor();
			window.aceEditor.getSession().setUseWrapMode(true);
			//Update the markdown display panel whenever the text is updated
			window.aceEditor.getSession().on('change', convertText);

			//Resize the ace editor to fit into the window everytime its resized
			$(window).resize(fitEditor);

			var loadData = function(data){
				data = JSON.parse(data)
				$('#language').val(data.language);
				window.aceEditor.getSession().setValue(data.paste_data);
				setAceMode(data.language);
			};

			var getData  = function(){
				var hash = window.location.hash.replace(/^#/, '');
				$.ajax({
					url: '/v1/get/' + hash
					,success: function(res){
						loadData(res);
						setShortUrl(hash);
					}
				})
			}

			var setShortUrl = function(hash){
				$('#short_url').val('http://'+window.location.host + '/#' + hash );
				window.location.hash = "#" + hash;
			}

			$('#markdown-edit').click(function(e){

				if( e.target.save ){
					columnMode('markdown');
					e.target.save = false;
					e.target.innerText = 'Show Markdown';
				}else{
					columnMode('markdown-edit')
					e.target.save = true;
					e.target.innerText = 'Hide Markdown';
				}

			});

			$('#language').change(function(){
				setAceMode(this.value);
			})

			$('#save-button').click(function(){
				var language = $('#language').val();
				var input = window.aceEditor.getSession().getValue();
				var payload = {
					"paste_data": input
					,"language": language
				}

				$.ajax({
					url:'/v1/save'
					, type: 'POST'
					, data: {"data":JSON.stringify(payload)}
					, success: function(res){
						setShortUrl(res)
					}
				})
			});

			window.onhashchange = getData;

			if (window.location.hash){
				getData();
			}

		});
	</script>

</body>
</html>
